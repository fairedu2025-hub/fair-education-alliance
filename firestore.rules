rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function emailMatchesUserId(userId) {
      return isSignedIn() && request.auth.token.email == (userId + "@myapp.com");
    }

    // 운영 관리자 계정(필요 시 추가/수정)
    function isAdmin() {
      return isSignedIn() && (
        request.auth.token.email == "admin@myapp.com" ||
        request.auth.token.email == "admin1@myapp.com" ||
        request.auth.token.email == "chusa77@myapp.com"
      );
    }

    // 사용자 프로필 문서:
    // - 본인 계정은 읽기/쓰기 가능(단 level 변경은 금지)
    // - 관리자는 모든 사용자 읽기/쓰기 가능
    match /users/{userId} {
      allow read: if emailMatchesUserId(userId) || isAdmin();
      allow create: if emailMatchesUserId(userId) || isAdmin();
      allow update: if isAdmin()
        || (emailMatchesUserId(userId)
          && request.resource.data.level == resource.data.level);
      allow delete: if isAdmin() || emailMatchesUserId(userId);
    }

    // 소식/공지 문서: 공개 읽기 허용 (필요 시 별도 제어)
    match /news/{newsId} {
      allow read: if true;
      allow write: if isSignedIn();
    }

    // 게시판 문서: 공개 읽기 허용, 인증 사용자 쓰기 허용
    match /boardPosts/{postId} {
      allow read: if true;
      allow write: if isSignedIn();
    }

    // 행사 문서: 공개 읽기 허용, 인증 사용자 쓰기 허용
    match /events/{eventId} {
      allow read: if true;
      allow write: if isSignedIn();
    }

    // 행사 신청 문서: 인증 사용자 읽기/쓰기 허용
    match /eventApplications/{applicationId} {
      allow read, write: if isSignedIn();
    }

    // 온라인 투표 문서: 공개 읽기 허용, 인증 사용자 쓰기 허용
    match /polls/{pollId} {
      allow read: if true;
      allow write: if isSignedIn();
    }

    // 관리자 탈퇴 처리 마커:
    // - 관리자는 생성/수정/삭제 가능
    // - 본인 계정 또는 관리자는 조회 가능 (로그인 차단 체크용)
    match /deletedUsers/{userId} {
      allow read: if emailMatchesUserId(userId) || isAdmin();
      allow create, update: if isAdmin();
      allow delete: if isAdmin() || emailMatchesUserId(userId);
    }

    // 사이트 설정 문서: 공개 읽기, 관리자 쓰기
    match /settings/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}
